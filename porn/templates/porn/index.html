<!DOCTYPE HTML>
<html>
  <head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://www.webglearth.com/v2/api.js"></script>
    <script type="text/javascript">
      var earth;
      function initialize() {
        earth = new WE.map('earth_div');
        WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(earth);
        addControllers();
        addMarkers();
      }
    
      function addControllers() {
        $("body").keydown(function(e) {
          c = earth.getPosition();
          zoom = Math.round(earth.getZoom());
          offset = 1.5
          switch (e.which) {
            case 37: //left arrow
              earth.setCenter([c[0], c[1] - offset]);
              break;
            case 38: //up arrow
              earth.setCenter([c[0] + offset, c[1]]);
              break;
            case 39: //right arrow
              earth.setCenter([c[0], c[1] + offset]);
              break;
            case 40: //down arrow
              earth.setCenter([c[0] - offset, c[1]]);
              break;
            case 190: // . pressed
              earth.setZoom(zoom - 0.5)
              break;
            case 191: // / pressed
              earth.setZoom(zoom + 0.5)
              break;
            default:
              //nothing
          }
        });
      }

      function addMarkers() {
        p = {{places|safe}}
        for (i = 0; i < p.length; i ++) {
          lat = p[i]['fields']['latitude'];
          lon = p[i]['fields']['longitude']
          marker = WE.marker([lat, lon]).addTo(earth);

          var popupTemplate = $("#marker-template").html();
          var $popup = $("<div/>").html(popupTemplate);
          $popup.find("#img").attr("src", p[i]['pk']);
          $popup.find("#caption").text(p[i]['fields']['caption']);
          marker.bindPopup($popup.html(), {maxWidth: 150, closeButton: true});
        }
      }
    </script>
    <style>
      html, body{padding: 0; margin: 0;}
      #earth_div{top: 0; right: 0; bottom: 0; left: 0; position: absolute !important;}
    </style>
  </head>
  <body onload="initialize()">
    <div id="earth_div"></div>
  </body>

  <script id="marker-template" type="text/temp">
    <img id="img" src="" height=140px width=140px></img>
    </div>
    <span id="caption" style='font-size:10px;color:#999'> </span>
  </script>
</html>