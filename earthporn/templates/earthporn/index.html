<!DOCTYPE HTML>
<html>
  <head>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.js"></script>
    <script src="http://www.webglearth.com/v2/api.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/select2/3.5.0/select2.min.css">
    <script type="text/javascript">
      var earth;
      var markers = [];
      function initialize() {
        options = { zoom: 4, position: [140.19537,80] };
        earth = new WE.map('earth-div', options);
        WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(earth);

        $("#dropdown-country").select2({
          placeholder: "Browse by avaliable country",
        });

        addMarkers();
        rotateEarth();
        animateMarkers();
      }

      function addMarkers() {
        p = {{places|safe}}
        for (i = 0; i < p.length; i ++) {
          lat = p[i]['fields']['latitude'];
          lon = p[i]['fields']['longitude']
          marker = WE.marker([lat, lon]).addTo(earth);
          markers.push(marker);

          var popupTemplate = $("#marker-template").html();
          var $popup = $("<div/>").html(popupTemplate);
          $popup.find("#img").attr("src", p[i]['pk']);
          $popup.find("#img-anchor").attr("href", p[i]['pk']);
          $popup.find("#caption").text(p[i]['fields']['caption']);
          marker.bindPopup($popup.html(), {maxWidth: 150, closeButton: true});
        }
      }

      function rotateEarth() {
        setInterval(function() {
          c = earth.getPosition();
          earth.setCenter([c[0], c[1] + 0.1]);
        }, 150);
      }

      function animateMarkers() {
         var lastm1 = getMarker();
         var lastm2 = getMarker();
        setInterval(function() {
          m1 = getMarker();
          m2 = getMarker();
          lastm1.closePopup();
          lastm2.closePopup();
          m1.openPopup();          
          m2.openPopup();
          lastm1 = m1;
          lastm2 = m2;          
        }, 2000);
      }

      function getMarker() {
        return markers[Math.floor(Math.random()*markers.length)];
      }
      </script>
      <style>
        html, body{padding: 0; margin: 0;}
        #earth-div{top: 0; right: 0; bottom: 0; left: 0; position: absolute !important;}
      </style>
    </script>
  </head>

  <body bgcolor="#F0F8FF" onload="initialize()">
    <div id="earth-div"></div>
    <form id="form" style="position: absolute; left: 20px; bottom: 150px">
      {% csrf_token %}
      <select name='country' id="dropdown-country" onchange="changeCountry(this.value)" style="width:250px">
        <option></option>
        {% for country in countries %}
          <option name="country_name" value='{{country}}'>{{country}}</option>
        {% endfor %}
      </select>
    </form> 

    <script type="text/javascript">
      function changeCountry(country_name) {
        location.replace('/country/' + country_name)
      } 
    </script>
  <body>

  <script id="marker-template" type="text/temp">
    <a id='img-anchor' href=''> <img id="img" src="" height=140px width=140px></img> </a>
    </div>
    <span id="caption" style='font-size:10px;color:#999'> </span>
  </script>

</html>